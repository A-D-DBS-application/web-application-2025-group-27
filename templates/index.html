{% extends "base.html" %}

{% block title %}{{ company.name if company else "Workspace" }} Workspace{% endblock %}

{% block content %}
<!-- Navigation Tabs -->
<div class="mb-6">
    <nav class="flex space-x-6 border-b border-slate-200">
        <button onclick="showTab('overview')" id="tab-overview" class="tab-button pb-3 px-1 text-sm font-medium text-slate-900 border-b-2 border-slate-900">
            Company Overview
        </button>
        <button onclick="showTab('competitors')" id="tab-competitors" class="tab-button pb-3 px-1 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700">
            Competitors
        </button>
        <button onclick="showTab('signals')" id="tab-signals" class="tab-button pb-3 px-1 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700">
            Signals
        </button>
    </nav>
</div>

<!-- Tab Content -->
<div id="content-overview" class="tab-content">

{% if company %}
<!-- Welcome Section -->
<div class="mb-6">
    <p class="text-xl font-bold text-slate-900 mb-2">
        Welcome back, {{ current_user.first_name }}
    </p>
    <p class="text-base text-slate-600">
        Your real-time overview is ready: updated company data, tracked competitors, and the newest shifts across your market.
    </p>
</div>

<!-- New Signals Banner -->
{% if unread_count and unread_count > 0 %}
<div class="mb-6 rounded-xl border border-blue-200 bg-blue-50 px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
            <i data-lucide="bell" class="w-5 h-5 text-blue-600"></i>
        </div>
        <div>
            <p class="text-sm font-medium text-blue-900">
                Hey {{ current_user.first_name }}, you have <span class="font-bold" data-count="{{ unread_count }}" data-type="number">0</span> new signal{% if unread_count == 1 %}{% else %}s{% endif %}!
            </p>
            <div class="flex items-center gap-3 mt-1">
                {% if unread_by_category.product > 0 %}
                <span class="text-xs text-blue-700">
                    <span class="font-bold" data-count="{{ unread_by_category.product }}" data-type="number">0</span> product
                </span>
                {% endif %}
                {% if unread_by_category.hiring > 0 %}
                <span class="text-xs text-blue-700">
                    <span class="font-bold" data-count="{{ unread_by_category.hiring }}" data-type="number">0</span> hiring
                </span>
                {% endif %}
                {% if unread_by_category.funding > 0 %}
                <span class="text-xs text-blue-700">
                    <span class="font-bold" data-count="{{ unread_by_category.funding }}" data-type="number">0</span> funding
                </span>
                {% endif %}
            </div>
        </div>
    </div>
    <button onclick="showTab('signals')" class="px-4 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 transition-colors duration-200">
        View Signals
    </button>
</div>
{% endif %}

<!-- Rivals Information Section -->
{% if company and competitor_view_models and metrics.competitor_count > 0 %}
<div class="mb-6">
    <div class="bg-slate-50 rounded-xl border border-slate-200 p-5">
        <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center flex-shrink-0">
                <i data-lucide="target" class="w-5 h-5 text-primary-600"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-slate-900 mb-2">What are Tracked Rivals?</h3>
                <p class="text-sm text-slate-600 leading-relaxed">
                    Tracked rivals are your key competitors that we monitor continuously. We track their company updates, 
                    hiring patterns, funding activities, and product changes to help you stay informed about market shifts 
                    and competitive movements in real-time.
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Rivals Section -->
{% if company and competitor_view_models and metrics.competitor_count > 0 %}
<div class="mb-6">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="font-display text-lg font-semibold text-slate-900">Tracked Rivals</h3>
                <p class="text-sm text-slate-600 mt-1">{{ metrics.competitor_count }} competitor{{ 's' if metrics.competitor_count != 1 else '' }} being monitored</p>
            </div>
            <a href="#competitors" onclick="showTab('competitors'); return false;" class="text-sm font-medium text-primary-600 hover:text-primary-700 transition-colors duration-200">
                View all →
            </a>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for view_model in competitor_view_models[:3] %}
                {% set link = view_model.link %}
                {% if link and link.competitor %}
                    <article class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:shadow-md transition-all duration-200">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-slate-900 text-sm mb-1 truncate">
                                    {% if link.competitor.name|lower == 'nike' %}Nike
                                    {% elif link.competitor.name|lower == 'adidas' %}Adidas
                                    {% else %}{{ link.competitor.name }}{% endif %}
                                </h4>
                                {% if link.competitor.domain %}
                                    <p class="text-xs text-slate-500 truncate">{{ link.competitor.domain }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-4 text-xs text-slate-600">
                            {% if link.competitor.number_of_employees %}
                                <span class="flex items-center gap-1">
                                    <i data-lucide="users" class="w-3 h-3"></i>
                                    {{ "{:,}".format(link.competitor.number_of_employees) }}
                                </span>
                            {% endif %}
                            {% if link.competitor.funding and link.competitor.funding > 0 %}
                                <span class="flex items-center gap-1">
                                    <i data-lucide="trending-up" class="w-3 h-3"></i>
                                    {% if link.competitor.funding >= 1000000000 %}
                                        €{{ "%.1f"|format(link.competitor.funding / 1000000000) }}B
                                    {% elif link.competitor.funding >= 1000000 %}
                                        €{{ "%.1f"|format(link.competitor.funding / 1000000) }}M
                                    {% elif link.competitor.funding >= 1000 %}
                                        €{{ "%.1f"|format(link.competitor.funding / 1000) }}K
                                    {% else %}
                                        €{{ "{:,.0f}".format(link.competitor.funding) }}
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                    </article>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Company Overview Section -->
<div class="mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <section>
            <div class="mb-6">
                <h2 class="font-display text-xl font-semibold text-slate-900">Company overview</h2>
            </div>
            
            <!-- Metrics Section -->
            <div class="mb-8">
                {% set metric_cards = [
                    {"label": "Team members", "value": metrics.user_count, "type": "number"},
                    {"label": "Industries", "value": metrics.industry_count, "type": "number"},
                    {"label": "Competitors tracked", "value": metrics.competitor_count, "type": "number"},
                    {"label": "Total funding", "value": metrics.total_funding, "type": "funding", "fallback": "Not available"},
                ] %}
                <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" aria-label="Key metrics">
                    {% for metric in metric_cards %}
                    {% set show_value = metric.type != "funding" or (metric.value and metric.value > 0) %}
                    <article class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm hover:shadow-md transition-shadow duration-200">
                        <span class="block text-sm font-medium text-slate-600 mb-2">{{ metric.label }}</span>
                        {% if show_value %}
                            <span class="block text-3xl font-bold text-slate-900" data-count="{{ metric.value or 0 }}" data-type="{{ metric.type }}">
                                {% if metric.type == "funding" %}€0{% else %}0{% endif %}
                            </span>
                        {% else %}
                            <span class="block text-3xl font-bold text-slate-900">{{ metric.fallback or "Not available" }}</span>
                        {% endif %}
                    </article>
                    {% endfor %}
                </section>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Company Card -->
                <article class="bg-slate-50 rounded-lg p-6 border border-slate-200 flex flex-col">
                    <header class="mb-4">
                        <h3 class="font-display text-lg font-semibold text-slate-900 mb-2">
                            {% if company.name|lower == 'nike' %}Nike
                            {% elif company.name|lower == 'adidas' %}Adidas
                            {% else %}{{ company.name }}{% endif %}
                        </h3>
                        {% if company.domain %}
                            <a class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-emerald-50 border border-emerald-200 rounded-lg hover:bg-emerald-100 transition-all duration-200" href="https://{{ company.domain }}" target="_blank">
                                {{ company.domain }}
                            </a>
                        {% endif %}
                    </header>
                    {% if company.headline %}
                        <p class="text-sm text-slate-600 mb-4 line-clamp-2">
                            {{ company.headline[:100] }}{% if company.headline|length > 100 %}...{% endif %}
                        </p>
                    {% endif %}
                    <ul class="space-y-2 mb-4 text-sm text-slate-700">
                        {% if company.number_of_employees %}
                            <li><strong class="text-slate-900">Employees:</strong> {{ "{:,}".format(company.number_of_employees) }}</li>
                        {% endif %}
                        {% if company.country %}
                            <li><strong class="text-slate-900">Country:</strong> {{ company.country }}</li>
                        {% endif %}
                        {% if company.funding and company.funding > 0 %}
                            <li>
                                <strong class="text-slate-900">Funding:</strong> 
                                {% if company.funding >= 1000000000 %}
                                    €{{ "%.1f"|format(company.funding / 1000000000) }}B
                                {% elif company.funding >= 1000000 %}
                                    €{{ "%.1f"|format(company.funding / 1000000) }}M
                                {% elif company.funding >= 1000 %}
                                    €{{ "%.1f"|format(company.funding / 1000) }}K
                                {% else %}
                                    €{{ "{:,.0f}".format(company.funding) }}
                                {% endif %}
                            </li>
                        {% endif %}
                    </ul>
                    {% set has_industries = false %}
                    {% if industries %}
                        {% set has_industries = true %}
                    {% endif %}
                    {% if has_industries %}
                        <div class="mb-4 pt-4 border-t border-slate-200">
                            <strong class="block text-xs font-semibold text-slate-900 mb-2">Industries</strong>
                            <div class="flex flex-wrap gap-2">
                                {% for industry in industries %}
                                    <span class="px-2 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg">
                                        {{ industry.name }}
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    {% elif company.industry %}
                        <div class="mb-4 pt-4 border-t border-slate-200">
                            <strong class="block text-xs font-semibold text-slate-900 mb-2">Industry</strong>
                            <div class="flex flex-wrap gap-2">
                                <span class="px-2 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg">
                                    {{ company.industry }}
                                </span>
                            </div>
                        </div>
                    {% endif %}
                    <footer class="mt-auto pt-4 border-t border-slate-200">
                        <a href="{{ url_for('main.company_detail') }}" class="block w-full text-center px-4 py-2.5 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-all duration-200 shadow-sm hover:shadow">
                            View Full Details →
                        </a>
                    </footer>
                </article>

                <!-- Team Members Card -->
                <article class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <header class="mb-4">
                        <h3 class="font-display text-xl font-semibold text-slate-900">Team members</h3>
                    </header>
                    {% if users %}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {% for user in users %}
                                <article class="bg-white rounded-lg p-4 border border-slate-200">
                                    <h4 class="font-semibold text-slate-900 mb-2">{{ user.first_name }} {{ user.last_name }}</h4>
                                    <ul class="space-y-1 text-sm text-slate-600">
                                        {% if user.role %}
                                            <li><strong class="text-slate-900">Role:</strong> {{ user.role }}</li>
                                        {% endif %}
                                        {% if user.email %}
                                            <li>
                                                <strong class="text-slate-900">Email:</strong> 
                                                <a href="mailto:{{ user.email }}" class="text-primary-600 hover:text-primary-700 transition-colors duration-200">
                                                    {{ user.email }}
                                                </a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </article>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-slate-500 text-sm">No team members yet.</p>
                    {% endif %}
                </article>
            </div>
            
            <!-- Last Updated -->
            {% if company.updated_at %}
            <div class="mt-6 pt-6 border-t border-slate-200">
                <p class="text-sm text-slate-500">
                    Last updated: {{ company.updated_at.strftime('%B %d, %Y at %H:%M') if company.updated_at else 'Never' }}
                </p>
            </div>
            {% endif %}
        </section>
    </div>
</div>
{% else %}
<p class="text-slate-500 text-center py-12">No company information available.</p>
{% endif %}

</div>

<!-- Competitors Tab Content -->
<div id="content-competitors" class="tab-content hidden">
{% if company and competitor_view_models and metrics.competitor_count > 0 %}
<div class="mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <section>
            <div class="mb-6 flex items-center justify-between">
                <div>
                    <h2 class="font-display text-xl font-semibold text-slate-900 mb-1">Competitors</h2>
                    <p class="text-sm text-slate-600">{{ metrics.competitor_count }} competitor{{ 's' if metrics.competitor_count != 1 else '' }} tracked</p>
                </div>
                <form action="{{ url_for('main.refresh_competitors_route') }}" method="POST" class="inline" onsubmit="handleRefreshSubmit(this, 'Refreshing...')">
                    <button type="submit" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-primary-700 bg-primary-50 border border-primary-200 rounded-lg hover:bg-primary-100 transition-all duration-200">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Refresh Competitors</span>
                    </button>
                </form>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for view_model in competitor_view_models %}
                    {% set link = view_model.link %}
                    {% if link and link.competitor %}
                        <article class="bg-slate-50 rounded-lg p-6 border border-slate-200 flex flex-col">
                            <header class="mb-4">
                                <h3 class="font-display text-lg font-semibold text-slate-900 mb-2">
                                    {% if link.competitor.name|lower == 'nike' %}Nike
                                    {% elif link.competitor.name|lower == 'adidas' %}Adidas
                                    {% else %}{{ link.competitor.name }}{% endif %}
                                </h3>
                                {% if link.competitor.domain %}
                                    <a class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-emerald-50 border border-emerald-200 rounded-lg hover:bg-emerald-100 transition-all duration-200" href="https://{{ link.competitor.domain }}" target="_blank">
                                        {{ link.competitor.domain }}
                                    </a>
                                {% endif %}
                            </header>
                            {% if link.competitor.headline %}
                                <p class="text-sm text-slate-600 mb-4 line-clamp-2">
                                    {{ link.competitor.headline[:100] }}{% if link.competitor.headline|length > 100 %}...{% endif %}
                                </p>
                            {% endif %}
                            <ul class="space-y-2 mb-4 text-sm text-slate-700">
                                {% if link.competitor.number_of_employees %}
                                    <li><strong class="text-slate-900">Employees:</strong> {{ "{:,}".format(link.competitor.number_of_employees) }}</li>
                                {% endif %}
                                {% if link.competitor.country %}
                                    <li><strong class="text-slate-900">Country:</strong> {{ link.competitor.country }}</li>
                                {% endif %}
                                {% if link.competitor.funding and link.competitor.funding > 0 %}
                                    <li>
                                        <strong class="text-slate-900">Funding:</strong> 
                                        {% if link.competitor.funding >= 1000000000 %}
                                            €{{ "%.1f"|format(link.competitor.funding / 1000000000) }}B
                                        {% elif link.competitor.funding >= 1000000 %}
                                            €{{ "%.1f"|format(link.competitor.funding / 1000000) }}M
                                        {% elif link.competitor.funding >= 1000 %}
                                            €{{ "%.1f"|format(link.competitor.funding / 1000) }}K
                                        {% else %}
                                            €{{ "{:,.0f}".format(link.competitor.funding) }}
                                        {% endif %}
                                    </li>
                                {% endif %}
                            </ul>
                            {% set has_industries = false %}
                            {% for industry_link in link.competitor.industries %}
                                {% if industry_link.industry %}
                                    {% set has_industries = true %}
                                {% endif %}
                            {% endfor %}
                            {% if has_industries %}
                                <div class="mb-4 pt-4 border-t border-slate-200">
                                    <strong class="block text-xs font-semibold text-slate-900 mb-2">Industries</strong>
                                    <div class="flex flex-wrap gap-2">
                                        {% for industry_link in link.competitor.industries %}
                                            {% if industry_link.industry %}
                                                <span class="px-2 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg">
                                                    {{ industry_link.industry.name }}
                                                </span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% elif link.competitor.industry %}
                                <div class="mb-4 pt-4 border-t border-slate-200">
                                    <strong class="block text-xs font-semibold text-slate-900 mb-2">Industry</strong>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-2 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg">
                                            {{ link.competitor.industry }}
                                        </span>
                                    </div>
                                </div>
                            {% endif %}
                            <footer class="mt-auto pt-4 border-t border-slate-200">
                                <a href="{{ url_for('main.competitor_detail', competitor_id=link.competitor.id) }}" class="block w-full text-center px-4 py-2.5 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-all duration-200 shadow-sm hover:shadow">
                                    View Full Details →
                                </a>
                            </footer>
                        </article>
                    {% endif %}
                {% endfor %}
            </div>
        </section>
    </div>
</div>
{% else %}
<p class="text-slate-500 text-center py-12">No competitors tracked yet.</p>
{% endif %}
</div>

<!-- Signals Tab Content -->
<div id="content-signals" class="tab-content hidden">
{% if company %}

<div class="mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <section>
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="font-display text-xl font-semibold text-slate-900 mb-1">Competitor Signals</h2>
                    <p class="text-sm text-slate-600">Changes detected in your competitors' organizations</p>
                </div>
                <form action="{{ url_for('main.refresh_signals') }}" method="POST" onsubmit="handleRefreshSubmit(this, 'Refreshing...')">
                    <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors duration-200">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Refresh Signals</span>
                    </button>
                </form>
            </div>
            
            {% if signals %}
            <div class="space-y-8">
                <!-- Hiring Signals -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2 cursor-pointer hover:text-slate-700 transition-colors" onclick="toggleCategory('hiring-signals')">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        Hiring Signals ({{ signals_by_category.hiring|length if signals_by_category.hiring else 0 }})
                        <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400 ml-auto category-chevron" id="chevron-hiring-signals"></i>
                    </h3>
                    <div id="hiring-signals" class="category-content hidden">
                    {% if signals_by_category.hiring %}
                    <div class="space-y-4">
                        {% for sig in signals_by_category.hiring %}
                        <div class="bg-slate-50 rounded-lg p-5 border border-slate-200 {% if sig.is_new %}ring-2 ring-blue-200{% endif %}">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    {% if sig.is_new %}
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">
                                        NEW
                                    </span>
                                    {% endif %}
                                    <h4 class="text-lg font-semibold text-slate-900">
                                        {% if sig.source_url %}
                                        <a href="{{ sig.source_url }}" target="_blank" rel="noopener noreferrer" class="hover:text-primary-600 hover:underline transition-colors duration-200">
                                            {{ sig.message }}
                                        </a>
                                        {% elif sig.competitor %}
                                        <a href="https://www.google.com/search?q={{ (sig.competitor.name + ' ' + sig.message)|urlencode }}" target="_blank" rel="noopener noreferrer" class="hover:text-primary-600 hover:underline transition-colors duration-200">
                                            {{ sig.message }}
                                        </a>
                                        {% else %}
                                        {{ sig.message }}
                                        {% endif %}
                                    </h4>
                                </div>
                                <!-- Severity Badge -->
                                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium
                                    {% if sig.severity == 'high' %}
                                        bg-red-50 text-red-700 border border-red-200
                                    {% elif sig.severity == 'medium' %}
                                        bg-amber-50 text-amber-700 border border-amber-200
                                    {% else %}
                                        bg-emerald-50 text-emerald-700 border border-emerald-200
                                    {% endif %}">
                                    {{ sig.severity|capitalize }}
                                </span>
                            </div>
                            {% if sig.competitor %}
                            <p class="text-xs text-slate-500 mb-2">
                                <i data-lucide="building-2" class="w-3 h-3 inline mr-1"></i>
                                Competitor: <a href="{{ url_for('main.competitor_detail', competitor_id=sig.competitor_id) }}" class="text-blue-600 hover:underline">{{ sig.competitor.name }}</a>
                            </p>
                            {% endif %}
                            <p class="text-slate-600 text-sm leading-relaxed">
                                {{ sig.details }}
                            </p>
                            {% if sig.created_at %}
                            <p class="mt-2 text-xs text-slate-500">
                                Detected on {{ sig.created_at.strftime('%Y-%m-%d at %H:%M') }}
                            </p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-slate-500 italic">No hiring signals yet.</p>
                    {% endif %}
                    </div>
                </div>

                <!-- Product Signals -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2 cursor-pointer hover:text-slate-700 transition-colors" onclick="toggleCategory('product-signals')">
                        <span class="w-2 h-2 rounded-full bg-purple-500"></span>
                        Product Signals ({{ signals_by_category.product|length if signals_by_category.product else 0 }})
                        <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400 ml-auto category-chevron" id="chevron-product-signals"></i>
                    </h3>
                    <div id="product-signals" class="category-content hidden">
                    {% if signals_by_category.product %}
                    <div class="space-y-4">
                        {% for sig in signals_by_category.product %}
                        <div class="bg-slate-50 rounded-lg p-5 border border-slate-200 {% if sig.is_new %}ring-2 ring-blue-200{% endif %}">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    {% if sig.is_new %}
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">
                                        NEW
                                    </span>
                                    {% endif %}
                                    <h4 class="text-lg font-semibold text-slate-900">
                                        {% if sig.source_url %}
                                        <a href="{{ sig.source_url }}" target="_blank" rel="noopener noreferrer" class="hover:text-primary-600 hover:underline transition-colors duration-200">
                                            {{ sig.message }}
                                        </a>
                                        {% elif sig.competitor %}
                                        <a href="https://www.google.com/search?q={{ (sig.competitor.name + ' ' + sig.message)|urlencode }}" target="_blank" rel="noopener noreferrer" class="hover:text-primary-600 hover:underline transition-colors duration-200">
                                            {{ sig.message }}
                                        </a>
                                        {% else %}
                                        {{ sig.message }}
                                        {% endif %}
                                    </h4>
                                </div>
                                <!-- Severity Badge -->
                                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium
                                    {% if sig.severity == 'high' %}
                                        bg-red-50 text-red-700 border border-red-200
                                    {% elif sig.severity == 'medium' %}
                                        bg-amber-50 text-amber-700 border border-amber-200
                                    {% else %}
                                        bg-emerald-50 text-emerald-700 border border-emerald-200
                                    {% endif %}">
                                    {{ sig.severity|capitalize }}
                                </span>
                            </div>
                            {% if sig.competitor %}
                            <p class="text-xs text-slate-500 mb-2">
                                <i data-lucide="building-2" class="w-3 h-3 inline mr-1"></i>
                                Competitor: <a href="{{ url_for('main.competitor_detail', competitor_id=sig.competitor_id) }}" class="text-blue-600 hover:underline">{{ sig.competitor.name }}</a>
                            </p>
                            {% endif %}
                            <p class="text-slate-600 text-sm leading-relaxed">
                                {{ sig.details }}
                            </p>
                            {% if sig.created_at %}
                            <p class="mt-2 text-xs text-slate-500">
                                Detected on {{ sig.created_at.strftime('%Y-%m-%d at %H:%M') }}
                            </p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-slate-500 italic">No product signals yet.</p>
                    {% endif %}
                    </div>
                </div>

                <!-- Funding Signals -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2 cursor-pointer hover:text-slate-700 transition-colors" onclick="toggleCategory('funding-signals')">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        Funding Signals ({{ signals_by_category.funding|length if signals_by_category.funding else 0 }})
                        <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400 ml-auto category-chevron" id="chevron-funding-signals"></i>
                    </h3>
                    <div id="funding-signals" class="category-content hidden">
                    {% if signals_by_category.funding %}
                    <div class="space-y-4">
                        {% for sig in signals_by_category.funding %}
                        <div class="bg-slate-50 rounded-lg p-5 border border-slate-200 {% if sig.is_new %}ring-2 ring-blue-200{% endif %}">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    {% if sig.is_new %}
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">
                                        NEW
                                    </span>
                                    {% endif %}
                                    <h4 class="text-lg font-semibold text-slate-900">
                                        {% if sig.source_url %}
                                        <a href="{{ sig.source_url }}" target="_blank" rel="noopener noreferrer" class="hover:text-primary-600 hover:underline transition-colors duration-200">
                                            {{ sig.message }}
                                        </a>
                                        {% elif sig.competitor %}
                                        <a href="https://www.google.com/search?q={{ (sig.competitor.name + ' ' + sig.message)|urlencode }}" target="_blank" rel="noopener noreferrer" class="hover:text-primary-600 hover:underline transition-colors duration-200">
                                            {{ sig.message }}
                                        </a>
                                        {% else %}
                                        {{ sig.message }}
                                        {% endif %}
                                    </h4>
                                </div>
                                <!-- Severity Badge -->
                                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium
                                    {% if sig.severity == 'high' %}
                                        bg-red-50 text-red-700 border border-red-200
                                    {% elif sig.severity == 'medium' %}
                                        bg-amber-50 text-amber-700 border border-amber-200
                                    {% else %}
                                        bg-emerald-50 text-emerald-700 border border-emerald-200
                                    {% endif %}">
                                    {{ sig.severity|capitalize }}
                                </span>
                            </div>
                            {% if sig.competitor %}
                            <p class="text-xs text-slate-500 mb-2">
                                <i data-lucide="building-2" class="w-3 h-3 inline mr-1"></i>
                                Competitor: <a href="{{ url_for('main.competitor_detail', competitor_id=sig.competitor_id) }}" class="text-blue-600 hover:underline">{{ sig.competitor.name }}</a>
                            </p>
                            {% endif %}
                            <p class="text-slate-600 text-sm leading-relaxed">
                                {{ sig.details }}
                            </p>
                            {% if sig.created_at %}
                            <p class="mt-2 text-xs text-slate-500">
                                Detected on {{ sig.created_at.strftime('%Y-%m-%d at %H:%M') }}
                            </p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-slate-500 italic">No funding signals yet.</p>
                    {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-slate-50 rounded-lg p-8 text-center border border-slate-200">
                <div class="w-16 h-16 rounded-full bg-emerald-50 flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="check-circle" class="w-8 h-8 text-primary-600"></i>
                </div>
                <h3 class="font-display text-lg font-semibold text-slate-900 mb-2">No Competitor Signals Yet</h3>
                <p class="text-slate-600 text-sm mb-4">We're monitoring your competitors for changes. Signals will appear here when we detect meaningful shifts in their organization, funding, or strategy.</p>
                <form action="{{ url_for('main.refresh_signals') }}" method="POST" class="inline">
                    <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-900 rounded-lg hover:bg-slate-800 transition-colors duration-200">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Check for Signals
                    </button>
                </form>
            </div>
            {% endif %}
        </section>
    </div>
</div>

<!-- Competitor Profiles Section -->
{% if competitor_snapshots %}
<div class="mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <section>
            <div class="mb-6">
                <h2 class="font-display text-xl font-semibold text-slate-900 mb-1">Competitor Profiles</h2>
                <p class="text-sm text-slate-600">AI-generated intelligence profiles for your competitors</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for comp_id, snapshot in competitor_snapshots.items() %}
                <div class="bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                    <!-- Header -->
                    <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
                                <i data-lucide="building-2" class="w-5 h-5 text-indigo-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-slate-900">{{ snapshot.competitor_name }}</h3>
                                {% if snapshot.data.basic and snapshot.data.basic.domain %}
                                <p class="text-xs text-slate-500">{{ snapshot.data.basic.domain }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <button onclick="toggleSnapshot('{{ comp_id }}')" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-indigo-700 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition-colors duration-200">
                            <i data-lucide="database" class="w-3 h-3"></i>
                            View Data
                        </button>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="px-5 py-3 grid grid-cols-3 gap-4 text-center border-b border-slate-200">
                        <div>
                            <p class="text-xs text-slate-500 mb-1">Size</p>
                            <p class="text-sm font-semibold text-slate-900">{{ snapshot.data.organization.employee_size if snapshot.data.organization else 'N/A' }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 mb-1">Country</p>
                            <p class="text-sm font-semibold text-slate-900">{{ snapshot.data.basic.country if snapshot.data.basic and snapshot.data.basic.country else 'N/A' }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 mb-1">Industries</p>
                            <p class="text-sm font-semibold text-slate-900">{{ snapshot.data.basic.industries|length if snapshot.data.basic and snapshot.data.basic.industries else 0 }}</p>
                        </div>
                    </div>
                    
                    <!-- Hiring Focus -->
                    {% if snapshot.data.hiring_focus %}
                    <div class="px-5 py-3 border-b border-slate-200">
                        <p class="text-xs font-medium text-slate-700 mb-2">Hiring Focus</p>
                        <div class="flex flex-wrap gap-2">
                            {% for role, score in snapshot.data.hiring_focus.items() %}
                                {% if score > 0 %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full
                                    {% if score >= 4 %}bg-emerald-100 text-emerald-700{% elif score >= 2 %}bg-amber-100 text-amber-700{% else %}bg-slate-100 text-slate-600{% endif %}">
                                    {{ role|replace('_', ' ')|title }}
                                    <span class="font-bold">{{ score }}</span>
                                </span>
                                {% endif %}
                            {% endfor %}
                            {% set has_hiring = namespace(value=false) %}
                            {% for role, score in snapshot.data.hiring_focus.items() %}
                                {% if score > 0 %}{% set has_hiring.value = true %}{% endif %}
                            {% endfor %}
                            {% if not has_hiring.value %}
                            <span class="text-xs text-slate-400">No hiring signals detected</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Strategic Profile Summary -->
                    {% if snapshot.data.strategic_profile %}
                    <div class="px-5 py-3">
                        {% if snapshot.data.strategic_profile.notable_strengths %}
                        <p class="text-xs font-medium text-slate-700 mb-1">Strengths</p>
                        <div class="flex flex-wrap gap-1 mb-2">
                            {% for strength in snapshot.data.strategic_profile.notable_strengths[:3] %}
                            <span class="px-2 py-0.5 text-xs bg-emerald-50 text-emerald-700 rounded">{{ strength }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if snapshot.data.strategic_profile.risk_factors %}
                        <p class="text-xs font-medium text-slate-700 mb-1">Risks</p>
                        <div class="flex flex-wrap gap-1">
                            {% for risk in snapshot.data.strategic_profile.risk_factors[:3] %}
                            <span class="px-2 py-0.5 text-xs bg-red-50 text-red-700 rounded">{{ risk }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Expandable Full Data -->
                    <div id="snapshot-{{ comp_id }}" class="hidden border-t border-slate-200 bg-slate-100">
                        <div class="px-5 py-4">
                            <p class="text-xs font-medium text-slate-700 mb-2">Full Snapshot Data (JSON)</p>
                            <pre class="text-xs bg-slate-900 text-emerald-400 p-4 rounded-lg overflow-x-auto max-h-64 overflow-y-auto">{{ snapshot.data|tojson(indent=2) }}</pre>
                            {% if snapshot.created_at %}
                            <p class="mt-2 text-xs text-slate-500">Last updated: {{ snapshot.created_at }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
    </div>
</div>
{% endif %}

{% else %}
<p class="text-slate-500 text-center py-12">No company information available.</p>
{% endif %}
</div>

<script>
// Handle refresh button loading state
function handleRefreshSubmit(form, loadingText) {
    const btn = form.querySelector('button[type="submit"]');
    const icon = btn.querySelector('[data-lucide="refresh-cw"]');
    const textSpan = btn.querySelector('span');
    
    // Add spinning animation to icon
    if (icon) {
        icon.classList.add('animate-spin');
    }
    
    // Update button text
    if (textSpan) {
        textSpan.textContent = loadingText;
    }
    
    // Disable button
    btn.disabled = true;
    btn.style.opacity = '0.7';
    btn.style.cursor = 'wait';
}

function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active state from all tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('text-slate-900', 'border-slate-900');
        button.classList.add('text-slate-500', 'border-transparent');
    });
    
    // Show selected tab content
    document.getElementById('content-' + tabName).classList.remove('hidden');
    
    // Add active state to selected tab
    const activeButton = document.getElementById('tab-' + tabName);
    activeButton.classList.remove('text-slate-500', 'border-transparent');
    activeButton.classList.add('text-slate-900', 'border-slate-900');
    
    // Re-initialize Lucide icons for newly visible content
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function toggleSnapshot(compId) {
    const elem = document.getElementById('snapshot-' + compId);
    if (elem) {
        elem.classList.toggle('hidden');
    }
}

function toggleCategory(categoryId) {
    const content = document.getElementById(categoryId);
    const chevron = document.getElementById('chevron-' + categoryId);
    
    if (content && chevron) {
        const isHidden = content.classList.contains('hidden');
        
        if (isHidden) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
        
        // Re-initialize Lucide icons for newly visible content
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
}

// Initialize: show overview tab by default, or tab from URL hash
document.addEventListener('DOMContentLoaded', function() {
    // Check for hash fragment in URL (e.g., #competitors, #signals)
    const hash = window.location.hash.substring(1); // Remove the '#' symbol
    const validTabs = ['overview', 'competitors', 'signals'];
    
    if (hash && validTabs.includes(hash)) {
        showTab(hash);
    } else {
        showTab('overview');
    }
    
    // Initialize chevron transitions for category toggles
    const categoryChevrons = document.querySelectorAll('.category-chevron');
    categoryChevrons.forEach(chevron => {
        chevron.style.transition = 'transform 0.2s ease-in-out';
    });
    
    // Animate counting numbers
    function formatFunding(value) {
        if (value >= 1000000000) {
            return '€' + (value / 1000000000).toFixed(1) + 'B';
        } else if (value >= 1000000) {
            return '€' + (value / 1000000).toFixed(1) + 'M';
        } else if (value >= 1000) {
            return '€' + (value / 1000).toFixed(1) + 'K';
        } else {
            return '€' + Math.floor(value).toLocaleString();
        }
    }
    
    function animateCounter(element, target, type, delay = 0) {
        const start = 0;
        // Vary duration based on target value for more natural feel
        // Smaller numbers animate faster, larger numbers take longer
        const baseDuration = 1500;
        const duration = baseDuration + (target * 10); // Add 10ms per unit
        const maxDuration = 2500; // Cap at 2.5 seconds
        const finalDuration = Math.min(duration, maxDuration);
        
        setTimeout(() => {
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / finalDuration, 1);
                
                // Ease out cubic for smooth, natural animation
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (target - start) * easeOutCubic);
                
                if (type === 'funding') {
                    element.textContent = formatFunding(current);
                } else {
                    element.textContent = current;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    // Ensure final value is exact
                    if (type === 'funding') {
                        element.textContent = formatFunding(target);
                    } else {
                        element.textContent = target;
                    }
                }
            }
            
            requestAnimationFrame(update);
        }, delay);
    }
    
    // Find all counter elements
    const counters = document.querySelectorAll('[data-count]');
    if (counters.length > 0) {
        // Animate with staggered delays for natural flow
        counters.forEach((counter, index) => {
            const target = parseInt(counter.getAttribute('data-count'));
            const type = counter.getAttribute('data-type');
            if (target > 0) {
                // Stagger animations: 100ms delay between each counter
                const delay = index * 100;
                animateCounter(counter, target, type, delay);
            }
        });
    }
});
</script>
{% endblock %}
